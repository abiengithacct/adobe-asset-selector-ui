<script>
    const CONFIG = {
        CLIENT_ID: '466f31740dc24133a32506acb2823d3f',
        REDIRECT_URI: 'https://abiengithacct.github.io/adobe-asset-selector-ui', // This MUST match your registered redirect URI
        AEM_HOST: 'https://author-p173552-e1855304.adobeaemcloud.com',
        IMS_AUTH_URL: 'https://ims-na1.adobelogin.com/ims/authorize/v2',
        SCOPE: 'AdobeID,openid,aem.folders,aem.assets.author'
    };

    let imsInstance = null;
    const connectDamBtn = document.getElementById('connectDamBtn');
    const assetSelectorModal = document.getElementById('asset-selector-modal');

    // --- Modal Control Functions (Adjusted for your new div structure) ---
    function closeAssetSelector() {
        assetSelectorModal.style.display = 'none';
    }

    function openAssetSelectorModal() {
        assetSelectorModal.style.display = 'flex';
    }
    
    // --- Toast Function (Corrected and self-contained) ---
    function showToast(title, body, type = 'info') {
        const toastContainer = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<strong>${title}</strong><span>${body}</span>`;
        toastContainer.appendChild(toast);

        setTimeout(() => {
            toast.remove();
        }, 4000);
    }
    
    // --- Core Asset Selector Logic ---

    /**
     * Sets up the Asset Selector and renders it into the container.
     * @param {boolean} launchModal - Whether to automatically show the modal after rendering.
     */
    function setupAndRenderSelector(launchModal = false) {
        if (!imsInstance) {
            console.error('IMS instance not available. Cannot render selector.');
            return;
        }
        
        const assetProps = {
            aemHost: CONFIG.AEM_HOST,
            repositoryId: 'crx',
            assetRepositoryId: 'crx',
            env: 'prod',
            selectMode: 'single',
            allowedAssetMimeTypes: ['image/png', 'image/jpeg', 'image/jpg'],
            authService: imsInstance,
            imsAuthorizationUrl: CONFIG.IMS_AUTH_URL,

            onAssetSelect: (assets) => {
                if (assets && assets.length > 0) {
                    const asset = assets[0];
                    updateAssetUI(asset);
                }
                closeAssetSelector();
                connectDamBtn.disabled = false;
                connectDamBtn.textContent = 'Select Image from DAM';
            }
        };

        const container = document.getElementById('asset-selector-container');
        container.innerHTML = '';
        
        // This renders the Asset Selector UI components inside the container div.
        window.PureJSSelectors.renderAssetSelectorWithAuthFlow(
            container,
            assetProps,
            () => {
                connectDamBtn.disabled = false;
                connectDamBtn.textContent = 'Select Image from DAM'; // Button updates once ready
                if (launchModal) {
                    openAssetSelectorModal();
                }
            }
        );
    }

    /**
     * Initializes IMS service and handles authentication flow (token check or login start).
     * @param {boolean} autoLaunch - Whether to automatically show the dialog after successful login.
     */
    function initAssetSelector(autoLaunch = false) {
        if (!window.PureJSSelectors) {
            showToast('Error', 'SDK not loaded. Please wait.', 'error');
            setTimeout(() => initAssetSelector(autoLaunch), 500);
            return;
        }

        connectDamBtn.disabled = true;
        connectDamBtn.textContent = 'Initializing...';

        const imsProps = {
            imsClientId: CONFIG.CLIENT_ID,
            imsEnvironment: 'prod',
            imsScope: CONFIG.SCOPE,
            redirectUrl: CONFIG.REDIRECT_URI,
            imsAuthorizationUrl: CONFIG.IMS_AUTH_URL,
            modalMode: true, // Use pop-up for login

            onImsServiceInitialized: (service) => {
                imsInstance = service;
                // If we land here after a redirect with a 'code', the SDK handles token exchange internally.
                if (imsInstance.hasAccessToken() || new URLSearchParams(window.location.search).get('code')) {
                    setupAndRenderSelector(autoLaunch);
                } else {
                    // Ready to connect, awaiting user click
                    connectDamBtn.disabled = false;
                    connectDamBtn.textContent = 'Connect to DAM';
                }
            },
            onAccessTokenReceived: (token) => {
                // Fired upon token receipt/exchange, especially after a successful pop-up login.
                showToast('Success', 'Authenticated with Adobe', 'success');
                // Clean up URL after token exchange
                window.history.replaceState({}, document.title, CONFIG.REDIRECT_URI); 
            },
            onErrorReceived: (type, msg) => {
                console.error('✗ IMS Error:', type, msg);
                showToast('Error', msg || 'Authentication failed.', 'error');
                connectDamBtn.disabled = false;
                connectDamBtn.textContent = 'Connect to DAM';
            }
        };

        try {
            window.PureJSSelectors.registerAssetsSelectorsAuthService(imsProps);
        } catch (error) {
            console.error('IMS registration error:', error);
            showToast('Error', 'IMS registration failed: ' + error.message, 'error');
        }
    }
    
    // Function bound to the button click (onclick="launchAssetSelector()")
    function launchAssetSelector() {
        // Only launch the selector modal if we have a token (already logged in)
        if (imsInstance && imsInstance.hasAccessToken()) {
            openAssetSelectorModal();
        } else {
            // Otherwise, kick off the full initialization and login flow, set to auto-launch modal
            // Note: If initAssetSelector was already called on load, this will just call setupAndRenderSelector(true) 
            initAssetSelector(true); 
        }
    }

    // --- UI Update Utilities ---
    function updateAssetUI(asset) {
        // ... (Your existing UI update logic here)
        const selectedAssetPreview = document.getElementById('selectedAssetPreview');
        const assetPreviewImg = document.getElementById('assetPreviewImg');
        const assetName = document.getElementById('assetName');
        const assetMeta = document.getElementById('assetMeta');
        const adobeDamBox = document.getElementById('adobeDamBox');
        const damTitle = document.getElementById('damTitle');

        assetPreviewImg.src = asset.uri || asset.path || '';
        assetName.textContent = asset.name || 'Unknown Asset';
        assetMeta.textContent = `Size: ${formatBytes(asset.size || 0)} | Type: ${asset.mimeType || 'unknown'}`;
        
        selectedAssetPreview.classList.add('active');
        adobeDamBox.classList.add('connected');
        damTitle.textContent = '✓ Asset Selected: ' + (asset.name || 'Unknown');
        
        window.selectedAsset = asset;
        showToast('Success', asset.name + ' selected', 'success');
    }

    function clearAsset() {
        // ... (Your existing clear asset logic here)
        const selectedAssetPreview = document.getElementById('selectedAssetPreview');
        const adobeDamBox = document.getElementById('adobeDamBox');
        const damTitle = document.getElementById('damTitle');
        
        selectedAssetPreview.classList.remove('active');
        adobeDamBox.classList.remove('connected');
        damTitle.textContent = 'Select an image from Adobe DAM';
        
        window.selectedAsset = null;
        showToast('Info', 'Asset cleared', 'info');
    }

    function formatBytes(bytes, decimals = 2) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const dm = decimals < 0 ? 0 : decimals;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
    }
    
    // Call the initialization function on page load to check for existing tokens or URL codes
    window.addEventListener('load', () => {
        initAssetSelector(false); 
    });
</script>
